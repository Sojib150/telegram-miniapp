<!-- save as index.html -->
<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>telegram-miniapp ‚Äî Dashboard</title>

  <!-- Monetag SDK: must be in HEAD -->
  <script src="//libtl.com/sdk.js" data-zone="9931551" data-sdk="show_9931551"></script>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Style (simple, clean) -->
  <style>
    :root{--accent:#2b7cff;--card:#fff}
    body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#f4f7ff,#ffffff);color:#0f172a}
    header{background:var(--accent);color:#fff;padding:14px 16px;text-align:center;font-weight:700}
    .container{max-width:420px;margin:18px auto;padding:0 12px}
    .card{background:var(--card);border-radius:12px;padding:16px;margin-bottom:12px;box-shadow:0 6px 18px rgba(12,20,60,0.06)}
    .title{font-size:18px;margin-bottom:8px}
    .small{color:#6b7280;font-size:13px}
    .btn{display:inline-block;width:100%;padding:12px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:700;cursor:pointer;margin-top:8px}
    .btn.secondary{background:#06b6d4}
    .footer-nav{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #eee;display:flex;justify-content:space-around;padding:8px 0}
    .nav-btn{font-size:14px;color:var(--accent);background:none;border:0}
  </style>

  <!-- Firebase helpers (compat) -->
  <script src="firebase.js"></script>
  <!-- Ads wrapper -->
  <script src="ads.js"></script>
</head>
<body>
  <header>üìä Mini Earn App</header>

  <div class="container">
    <div class="card">
      <div class="title">‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ</div>
      <div class="small">Telegram-‡¶è‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶Ö‡¶ü‡ßã-‡¶≤‡¶ó‡¶á‡¶® ‡¶π‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßá ‡¶ï‡ßü‡ßá‡¶® ‡¶ú‡¶ø‡¶§‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡•§</div>
    </div>

    <div class="card" id="profileCard">
      <div style="display:flex;gap:12px;align-items:center">
        <img id="avatar" src="https://i.pravatar.cc/100" style="width:68px;height:68px;border-radius:14px;object-fit:cover"/>
        <div>
          <div id="displayName" style="font-weight:700">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
          <div id="displayUsername" class="small">@username</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="small">‡¶ï‡ßü‡ßá‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡¶æ‡¶®‡ßç‡¶∏</div>
        <div id="coinCount" style="font-weight:800;font-size:20px">0</div>
      </div>
    </div>

    <div class="card">
      <div class="title">‡¶ï‡¶æ‡¶ú‡¶∏‡¶Æ‡ßÇ‡¶π</div>
      <div class="small">‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶® ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßã, ‡¶ó‡ßá‡¶Æ ‡¶ñ‡ßá‡¶≤‡ßã, ‡¶¨‡¶®‡ßç‡¶ß‡ßÅ ‡¶Ü‡¶®‡ßã ‚Äî ‡¶ï‡ßü‡ßá‡¶® ‡¶¨‡¶æ‡ßú‡¶æ‡¶ì‡•§</div>

      <button class="btn" id="watchAdBtn">‚ñ∂Ô∏é Watch Ad (10 coins)</button>
      <button class="btn secondary" id="playGameBtn">üéÆ Play Game (5 coins)</button>
      <button class="btn" id="inviteBtn" style="margin-top:6px;background:#f59e0b">üë• Invite</button>
    </div>
  </div>

  <div class="footer-nav">
    <button class="nav-btn" onclick="location.href='index.html'">üè† Home</button>
    <button class="nav-btn" onclick="location.href='ads.html'">üéÅ Ads</button>
    <button class="nav-btn" onclick="location.href='game.html'">üéÆ Game</button>
    <button class="nav-btn" onclick="location.href='profile.html'">üë§ Profile</button>
    <button class="nav-btn" onclick="location.href='withdraw.html'">üí≥ Withdraw</button>
  </div>

  <script>
    // Wait for firebase helpers to be ready
    function waitForHelpers(timeout = 5000){
      return new Promise((res, rej) => {
        const start = Date.now();
        (function check(){
          if(window.appHelpers) return res(window.appHelpers);
          if(Date.now() - start > timeout) return rej("appHelpers not found");
          setTimeout(check, 100);
        })();
      });
    }

    // Telegram WebApp
    const tg = window.Telegram?.WebApp;
    if(tg) tg.ready();

    (async ()=>{
      try{
        await waitForHelpers();
      }catch(e){ console.warn(e); }

      // get telegram user if inside Telegram WebApp
      let user = null;
      try { user = tg?.initDataUnsafe?.user || null; } catch(e){ user = null; }
      const userId = user?.id ? String(user.id) : ("guest_"+localStorage.getItem('guest_id') || (function(){ const g=Date.now(); localStorage.setItem('guest_id', g); return g; })());

      // ensure user doc in firestore
      if(window.appHelpers) await window.appHelpers.ensureUserDoc(userId, user || { name: "Guest" });

      // update UI
      if(user){
        document.getElementById('displayName').innerText = (user.first_name || '') + (user.last_name ? ' ' + user.last_name : '');
        document.getElementById('displayUsername').innerText = user.username ? '@' + user.username : '';
        if(user.photo_url) document.getElementById('avatar').src = user.photo_url;
      } else {
        document.getElementById('displayName').innerText = 'Guest';
        document.getElementById('displayUsername').innerText = '';
      }

      // show coins realtime
      if(window.appHelpers){
        window.appHelpers.onUserSnapshot(userId, snap => {
          if(!snap.exists) return;
          const data = snap.data();
          document.getElementById('coinCount').innerText = data.coins || 0;
        });
      }

      // Buttons
      document.getElementById('watchAdBtn').addEventListener('click', async () => {
        if(!window.MiniAds){ alert("Ads not ready"); return; }
        try{
          await window.MiniAds.showRewardedFor(userId, 10);
          alert("‚úÖ 10 coins added");
        }catch(e){
          console.error(e);
          alert("Ad failed or not available");
        }
      });

      document.getElementById('playGameBtn').addEventListener('click', async () => {
        // simple flow: open game page (or inline game). Here we simulate +5 coins after showing a rewarded popup.
        if(window.MiniAds) {
          try{
            await window.MiniAds.showPopupFor(userId, 5);
            alert("‚úÖ 5 coins added from game");
          }catch(e){ console.warn(e); alert("Ad not available"); }
        } else {
          alert("Play game (demo) ‚Äî +5 coins");
          if(window.appHelpers) window.appHelpers.addCoins(userId, 5);
        }
      });

      document.getElementById('inviteBtn').addEventListener('click', () => {
        const link = location.origin + location.pathname.replace(/\/[^/]*$/,'') + '/?ref=' + userId;
        navigator.clipboard.writeText(link).then(()=> alert("Invite link copied"));
      });

      // init inApp interstitial auto
      if(window.MiniAds && typeof window.MiniAds.initInApp === 'function') window.MiniAds.initInApp();
    })();
  </script>
</body>
</html>
