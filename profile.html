<!-- save as profile.html -->
<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profile â€” Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{margin:0;font-family:Inter,Arial;background:linear-gradient(180deg,#6a11cb,#2575fc);color:#fff;min-height:100vh;display:flex;flex-direction:column;align-items:center}
    .card{background:rgba(255,255,255,0.08);backdrop-filter:blur(6px);border-radius:14px;padding:20px;width:92%;max-width:420px;margin-top:40px;box-shadow:0 12px 30px rgba(0,0,0,0.18)}
    .avatar{width:96px;height:96px;border-radius:20px;object-fit:cover;border:3px solid rgba(255,255,255,0.18)}
    .name{font-weight:700;font-size:20px;margin-top:12px}
    .meta{color:rgba(255,255,255,0.8);margin-bottom:6px}
    .coin{margin-top:12px;background:rgba(255,255,255,0.12);padding:12px;border-radius:10px;font-weight:700}
    .btn{margin-top:12px;padding:10px 16px;border-radius:10px;border:0;background:#ffd166;color:#1f2937;font-weight:700;cursor:pointer}
  </style>
  <!-- firebase helpers (same file) -->
  <script src="firebase.js"></script>
</head>
<body>
  <div class="card" id="profileCard">
    <img id="avatar" class="avatar" src="https://i.pravatar.cc/200" alt="avatar">
    <div class="name" id="name">Loading...</div>
    <div class="meta" id="username">@username</div>
    <div class="coin">ðŸ’° Coins: <span id="coins">0</span></div>

    <div style="display:flex;gap:10px;margin-top:12px">
      <button class="btn" id="watchBtn">Watch Ad +10</button>
      <button class="btn" id="withdrawBtn">Withdraw</button>
    </div>
  </div>

  <script src="ads.js"></script>
  <script>
    const tg = window.Telegram?.WebApp;
    if(tg) tg.ready();

    (async ()=>{
      // wait for firebase helpers
      function wait() { return new Promise(res => {
        const st = setInterval(()=>{ if(window.appHelpers){ clearInterval(st); res(); } },80);
      }); }
      await wait();

      const user = tg?.initDataUnsafe?.user || null;
      const userId = user?.id ? String(user.id) : ("guest_"+localStorage.getItem('guest_id') || (function(){ const g=Date.now(); localStorage.setItem('guest_id', g); return g; })());

      // ensure user in Firestore
      await window.appHelpers.ensureUserDoc(userId, user || { name: 'Guest' });

      // update UI
      if(user){
        document.getElementById('name').innerText = (user.first_name || '') + (user.last_name ? ' '+user.last_name : '');
        document.getElementById('username').innerText = user.username ? '@'+user.username : '';
        if(user.photo_url) document.getElementById('avatar').src = user.photo_url;
      } else {
        document.getElementById('name').innerText = 'Guest';
      }

      // realtime coins
      window.appHelpers.onUserSnapshot(userId, snap => {
        if(!snap.exists) return;
        document.getElementById('coins').innerText = snap.data().coins || 0;
      });

      document.getElementById('watchBtn').addEventListener('click', async () => {
        try{
          await window.MiniAds.showRewardedFor(userId, 10);
          alert("âœ… 10 coins added");
        }catch(e){ console.warn(e); alert("Ad not available"); }
      });

      document.getElementById('withdrawBtn').addEventListener('click', ()=> {
        const name = prompt("à¦¬à¦¿à¦•à¦¾à¦¶ à¦¨à¦¾à¦®à§à¦¬à¦¾à¦° à¦¨à¦¿à¦¬à§‡à¦¨? à¦†à¦ªà¦¨à¦¾à¦° à¦¨à¦¾à¦® à¦²à¦¿à¦–à§à¦¨:");
        if(!name) return;
        const number = prompt("à¦¬à¦¿à¦•à¦¾à¦¶ à¦¨à¦¾à¦®à§à¦¬à¦¾à¦° à¦²à¦¿à¦–à§à¦¨ (01xxxxxxxxx):");
        if(!number) return;
        (async ()=>{
          const coins = await window.appHelpers.getCoins(userId);
          if(coins < 1000){ alert("à¦¨à§à¦¯à§‚à¦¨à¦¤à¦® 1000 à¦•à§Ÿà§‡à¦¨ à¦²à¦¾à¦—à¦¬à§‡ (100 TK)"); return; }
          const amountTk = Math.floor(coins/1000)*100;
          await window.appHelpers.createWithdrawRequest(userId, name, number, coins, amountTk);
          // set user's coins remainder
          const remain = coins % 1000;
          await window.appHelpers.db.collection('users').doc(userId).update({ coins: remain });
          alert("âœ… Withdraw request sent for "+amountTk+" TK");
        })();
      });
    })();
  </script>
</body>
</html>
