<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Game â€” Banana Pop</title>

  <!-- Monetag SDK (HEAD) -->
  <script src="//libtl.com/sdk.js" data-zone="9931551" data-sdk="show_9931551"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
    body{margin:0;font-family:Inter,Arial;background:linear-gradient(180deg,#fff8e6,#fff);display:flex;flex-direction:column;min-height:100vh}
    header{background:#ffb020;color:#1f2937;padding:12px;text-align:center;font-weight:700}
    .wrap{max-width:420px;margin:16px auto;padding:12px;width:92%}
    .card{background:#fff;border-radius:12px;padding:12px;box-shadow:0 8px 20px rgba(15,23,42,0.06)}
    canvas{display:block;width:100%;height:520px;border-radius:10px;background:linear-gradient(#fff,#fffbe6);touch-action:none}
    .info{display:flex;justify-content:space-between;align-items:center;padding:10px 0}
    .btn{padding:10px 14px;border-radius:10px;border:0;background:#10b981;color:#fff;font-weight:700;cursor:pointer}
  </style>
</head>
<body>
  <header>ðŸŽ® Banana Pop â€” Game</header>

  <div class="wrap">
    <div class="card">
      <div class="info">
        <div>Score: <b id="score">0</b></div>
        <div>Coins: <b id="coins">0</b></div>
        <button id="startBtn" class="btn">Start 20s Game</button>
      </div>
      <div class="card" style="padding:8px;margin-top:8px">
        <canvas id="gameCanvas" width="360" height="520"></canvas>
      </div>
      <p class="small" id="msg" style="color:#475569;margin-top:8px">Tap bananas to pop â€” final score Ã—2 coins reward after ad.</p>
    </div>
  </div>

<script>
/* ===== Firebase init (compat) ===== */
const firebaseConfig = {
  apiKey: "AIzaSyB6b93A_HeU4FADs3o2Ysw6-dlRRS2TbZk",
  authDomain: "telegram-miniapp-e8cc0.firebaseapp.com",
  projectId: "telegram-miniapp-e8cc0",
  storageBucket: "telegram-miniapp-e8cc0.firebasestorage.app",
  messagingSenderId: "827930913054",
  appId: "1:827930913054:web:502b56e0c198d8e9ff410f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ===== Helpers ===== */
function getTelegramUser(){ try{ return window.Telegram?.WebApp?.initDataUnsafe?.user || null }catch(e){return null} }
function getGuestId(){ let g=localStorage.getItem('guest_id'); if(!g){g='guest_'+Date.now()+'_'+Math.random().toString(36).slice(2,6); localStorage.setItem('guest_id',g)} return g}
async function ensureUserDoc(userId,userObj={}){ const ref=db.collection('users').doc(String(userId)); const snap=await ref.get(); if(!snap.exists){ await ref.set({ name:userObj.first_name||userObj.name||'Guest', username:userObj.username||null, telegramId:userId, coins:0, createdAt:new Date().toISOString() }); } return ref;}
async function addCoins(userId,amount){ const ref=db.collection('users').doc(String(userId)); await db.runTransaction(async tx=>{ const d=await tx.get(ref); if(!d.exists) tx.set(ref,{coins:amount}); else tx.update(ref,{coins:(d.data().coins||0)+amount}); }); }

/* ===== Game logic ===== */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let W = canvas.width = 360;
let H = canvas.height = 520;
let bubbles = [], score=0, running=false, spawnInt, gameTimer;

function spawnBanana(){
  const size = 30 + Math.random()*36;
  const x = Math.random()*(W - size) + size/2;
  const y = H + size;
  const speed = 1.5 + Math.random()*2;
  const id = Math.random().toString(36).slice(2,9);
  bubbles.push({x,y,size,speed,id});
}

function draw(){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = "#fff";
  for(let i=bubbles.length-1;i>=0;i--){
    const b = bubbles[i];
    b.y -= b.speed;
    // draw banana (simple circle yellow)
    ctx.beginPath();
    ctx.fillStyle = "rgba(255,205,64,0.98)";
    ctx.ellipse(b.x,b.y,b.size*0.6,b.size*0.45, Math.PI/6, 0, Math.PI*2);
    ctx.fill();
    ctx.closePath();
    // remove if off-top
    if(b.y + b.size < -20) bubbles.splice(i,1);
  }
  requestAnimationFrame(draw);
}

canvas.addEventListener('pointerdown', function(e){
  if(!running) return;
  const rect = canvas.getBoundingClientRect();
  const mx = (e.clientX - rect.left) * (canvas.width / rect.width);
  const my = (e.clientY - rect.top) * (canvas.height / rect.height);
  for(let i=bubbles.length-1;i>=0;i--){
    const b=bubbles[i];
    const d = Math.hypot(mx - b.x, my - b.y);
    if(d < b.size*0.7){
      bubbles.splice(i,1);
      score++;
      document.getElementById('score').innerText = score;
    }
  }
});

/* ===== Start / End ===== */
document.getElementById('startBtn').addEventListener('click', async ()=>{
  if(running) return;
  // init user
  const user = getTelegramUser();
  const userId = user?.id ? String(user.id) : getGuestId();
  await ensureUserDoc(userId, user || { name:'Guest' });

  // reset
  bubbles = []; score = 0; document.getElementById('score').innerText = 0;
  running = true; document.getElementById('msg').innerText = 'Game started â€” tap bananas!';
  // spawn and draw
  spawnInt = setInterval(spawnBanana, 600);
  draw();
  // 20s game
  gameTimer = setTimeout(async ()=>{
    running = false;
    clearInterval(spawnInt);
    document.getElementById('msg').innerText = 'Game over â€” showing ad and rewarding...';
    // show rewarded ad, then reward score*2 coins
    try {
      await show_9931551(); // Monetag rewarded
    } catch(e){
      console.warn('Ad error', e);
      // even if ad not available, proceed to reward (you may change policy)
    }
    const reward = Math.max(0, Math.floor(score * 2));
    if(reward > 0){
      await addCoins(userId, reward);
      document.getElementById('coins').innerText = await getCoinsLocal(userId);
    }
    document.getElementById('msg').innerText = `Game over â€” Score ${score}, rewarded ${reward} coins.`;
  }, 20000);
});

/* ===== coins UI and helper to read coins quickly ===== */
async function getCoinsLocal(userId){
  const snap = await db.collection('users').doc(String(userId)).get();
  return snap.exists ? (snap.data().coins || 0) : 0;
}

(async function initProfileCoins(){
  const tg = window.Telegram?.WebApp;
  if(tg) tg.ready();
  const user = getTelegramUser();
  const userId = user?.id ? String(user.id) : getGuestId();
  await ensureUserDoc(userId, user || { name: 'Guest' });
  // show coins realtime
  db.collection('users').doc(String(userId)).onSnapshot(doc=>{
    if(!doc.exists) return;
    document.getElementById('coins').innerText = doc.data().coins || 0;
  });
})();
</script>
</body>
</html>
