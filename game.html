<!-- game.html -->
<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Banana Pop</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Monetag / Ad placeholder script loads on host -->
  <script async src='//libtl.com/sdk.js' data-zone='9931551' data-sdk='show_9931551'></script>
</head>
<body>
  <div class="card center">
    <h2>ðŸŽ® Banana Pop</h2>
    <div id="scoreWrap" style="margin-top:8px">
      <span id="scoreLabel">Score: 0</span> &nbsp; <span id="coinLabel">Coins: 0</span>
    </div>
    <canvas id="gameCanvas" width="360" height="460" style="margin-top:12px; display:block;"></canvas>

    <div id="adBanner" style="margin-top:12px; height:90px; border-radius:10px; border:1px solid #eef7ff; display:flex; align-items:center; justify-content:center;">
      <small class="small">Ad area (Monetag / Adsterra only on live host)</small>
    </div>
    <p class="small">Tip: Click the falling bananas to pop & earn coins</p>
  </div>

  <script type="module">
    import './app.js';
    // get user
    const user = window.appHelpers.getTelegramUser();
    const id = user?.id || localStorage.getItem('guest_user');

    // ensure user doc
    await window.appHelpers.ensureUserDoc(id, { name: user?.first_name, username: user?.username });

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreLabel = document.getElementById('scoreLabel');
    const coinLabel = document.getElementById('coinLabel');

    let bananas = [], score = 0, coins = await window.appHelpers.getUserCoins(id);

    coinLabel.innerText = 'Coins: ' + coins;

    function spawn() {
      const x = Math.random()*(canvas.width-40)+20;
      bananas.push({x,y:-30,size:40, speed:2+Math.random()*2});
    }
    function draw() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      bananas.forEach((b,i)=> {
        b.y += b.speed;
        ctx.beginPath();
        ctx.fillStyle = 'yellow';
        ctx.ellipse(b.x, b.y, b.size/2, b.size/2, 0,0,Math.PI*2);
        ctx.fill();
        ctx.closePath();
        if(b.y>canvas.height+50) bananas.splice(i,1);
      });
      requestAnimationFrame(draw);
    }

    canvas.addEventListener('click', async (e)=>{
      const rect = canvas.getBoundingClientRect();
      const cx = e.clientX - rect.left, cy = e.clientY - rect.top;
      for(let i=bananas.length-1;i>=0;i--){
        const b = bananas[i];
        const dist = Math.hypot(cx-b.x, cy-b.y);
        if(dist < b.size/1.5){
          bananas.splice(i,1);
          score++;
          scoreLabel.innerText = 'Score: ' + score;
          coins += 5; // reward per banana
          coinLabel.innerText = 'Coins: ' + coins;
          // credit to firebase
          await window.appHelpers.addCoinsToUser(id, 5);
          // show monetag ad occasionally
          if(score % 10 === 0 && typeof Monetag !== 'undefined' && Monetag.show_9931551) {
            try { Monetag.show_9931551(); } catch(e) { console.warn(e); }
          }
        }
      }
    });

    setInterval(spawn, 900);
    draw();
  </script>
</body>
</html>
