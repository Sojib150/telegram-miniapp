<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Banana Game</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
  <style>
    body { margin:0; overflow:hidden; background:#fef9c3; }
    canvas { display:block; }
    #score { position:absolute; top:20px; left:20px; font-size:24px; font-weight:bold; color:#333; }
  </style>
</head>
<body>
  <div id="score">üçå Score: 0</div>
  <canvas id="gameCanvas"></canvas>

<script>
  // Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyB6b93A_HeU4FADs3o2Ysw6-dlRRS2TbZk",
    authDomain: "telegram-miniapp-e8cc0.firebaseapp.com",
    projectId: "telegram-miniapp-e8cc0",
    storageBucket: "telegram-miniapp-e8cc0.firebasestorage.app",
    messagingSenderId: "827930913054",
    appId: "1:827930913054:web:502b56e0c198d8e9ff410f"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Telegram User
  const tg = window.Telegram.WebApp;
  tg.ready();
  const user = tg.initDataUnsafe?.user;
  let userId = user?.id?.toString();

  // Game
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  let bananas = [];
  let score = 0;

  function spawnBanana(){
    bananas.push({
      x: Math.random() * canvas.width,
      y: -50,
      speed: 2 + Math.random() * 3
    });
  }

  function drawBanana(b){
    ctx.beginPath();
    ctx.arc(b.x, b.y, 25, 0, Math.PI * 2);
    ctx.fillStyle = "yellow";
    ctx.fill();
    ctx.stroke();
    ctx.closePath();
  }

  canvas.addEventListener("click", e=>{
    bananas.forEach((b, i)=>{
      let dx = e.clientX - b.x;
      let dy = e.clientY - b.y;
      if(Math.sqrt(dx*dx + dy*dy) < 25){
        bananas.splice(i,1);
        score++;
        document.getElementById("score").innerText = "üçå Score: " + score;

        // üî• Save coins to Firebase
        if(userId){
          db.collection("users").doc(userId).update({
            coins: firebase.firestore.FieldValue.increment(1)
          });
        }
      }
    });
  });

  function gameLoop(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    bananas.forEach(b=>{
      b.y += b.speed;
      drawBanana(b);
    });
    bananas = bananas.filter(b=> b.y < canvas.height+50);
    requestAnimationFrame(gameLoop);
  }

  setInterval(spawnBanana, 1000);
  gameLoop();
</script>
</body>
</html>
