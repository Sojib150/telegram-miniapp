<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üéÆ Banana Pop ‚Äî ‡¶ó‡ßá‡¶Æ</title>
  <style>
    :root{--tg-blue:#229ED9;--card:#fff;--bg:#f6f8fb}
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#111}
    .wrap{max-width:420px;margin:18px auto;padding:12px}
    header{display:flex;align-items:center;gap:12px}
    header h1{font-size:18px;margin:0}
    .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 8px 24px rgba(10,10,10,0.06)}
    #gameArea{position:relative;width:100%;height:420px;border-radius:10px;background:linear-gradient(180deg,#e8f7ff, #f7fff7);overflow:hidden;border:1px solid #e6eef6;margin-top:12px}
    .hud{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
    .stat{background:#fff;padding:8px 12px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.04);font-weight:600}
    #controls{display:flex;gap:8px;margin-top:12px}
    .btn{flex:1;padding:10px;border-radius:8px;border:0;background:var(--tg-blue);color:#fff;font-weight:700;cursor:pointer}
    .btn.ghost{background:#fff;color:var(--tg-blue);border:1px solid #cfeafb}
    .banana{position:absolute;width:56px;height:56px;background:url('https://i.imgur.com/7k4K3qN.png') center/contain no-repeat;cursor:pointer;user-select:none}
    .pop{position:absolute;width:56px;height:56px;background:url('https://i.imgur.com/9p2S9sI.png') center/contain no-repeat;pointer-events:none}
    #resultBox{display:none;margin-top:12px;text-align:center}
    #adContainer{margin-top:12px;text-align:center}
    #claimBtn{margin-top:10px;padding:10px 14px;border-radius:8px;border:0;background:#28a745;color:#fff;font-weight:700;cursor:pointer}
    small.note{display:block;color:#666;margin-top:8px;text-align:center}
  </style>
  <!-- Telegram WebApp SDK (auto login only when opened via Telegram) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üéÆ Banana Pop</h1>
    </header>

    <div class="card">
      <div class="hud">
        <div class="stat">‚è± Time: <span id="timeLeft">20</span>s</div>
        <div class="stat">üçå Score: <span id="score">0</span></div>
        <div class="stat">üí∞ Reward: <span id="rewardPreview">0</span></div>
      </div>

      <div id="gameArea" aria-label="game area"></div>

      <div id="controls">
        <button id="startBtn" class="btn">‚ñ∂ Start Game</button>
        <button id="stopBtn" class="btn ghost" disabled>‚ñ† Stop</button>
      </div>

      <div id="resultBox">
        <h3 id="resultText"></h3>
        <div id="adContainer"></div>
        <p class="note">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶° ‡¶∂‡ßá‡¶∑ ‡¶π‡¶≤‡ßá "Claim Reward" ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶π‡¶¨‡ßá (‡ßß‡ß´ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ)</p>
        <button id="claimBtn" disabled>Claim Reward</button>
      </div>
    </div>
  </div>

  <script type="module">
  // ================== Firebase imports ==================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // === Firebase config (‡¶§‡ßã‡¶Æ‡¶æ‡¶∞) ===
  const firebaseConfig = {
    apiKey: "AIzaSyB6b93A_HeU4FADs3o2Ysw6-dlRRS2TbZk",
    authDomain: "telegram-miniapp-e8cc0.firebaseapp.com",
    projectId: "telegram-miniapp-e8cc0",
    storageBucket: "telegram-miniapp-e8cc0.firebasestorage.app",
    messagingSenderId: "827930913054",
    appId: "1:827930913054:web:502b56e0c198d8e9ff410f"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ============ Game variables ============
  const DURATION = 20;          // game seconds
  const SPAWN_INTERVAL = 700;   // ms between new bananas
  const FALL_SPEED_MIN = 2500;  // ms time to fall (min)
  const FALL_SPEED_MAX = 4500;  // ms time to fall (max)
  const BASE_REWARD = 5;        // base coins
  const MULTIPLIER = 3;         // coins per popped banana
  const MAX_REWARD = 300;       // cap

  const area = document.getElementById('gameArea');
  const timeEl = document.getElementById('timeLeft');
  const scoreEl = document.getElementById('score');
  const rewardPreviewEl = document.getElementById('rewardPreview');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const resultBox = document.getElementById('resultBox');
  const resultText = document.getElementById('resultText');
  const adContainer = document.getElementById('adContainer');
  const claimBtn = document.getElementById('claimBtn');

  let spawnTimer = null;
  let gameTimer = null;
  let gameTimeLeft = DURATION;
  let score = 0;
  let bananas = new Set();
  let gameRunning = false;
  let claimReady = false;

  // Telegram user (try WebApp then fallback to local)
  let telegramUser = null;
  try {
    if (window.Telegram && window.Telegram.WebApp) {
      const tg = window.Telegram.WebApp;
      tg.ready();
      telegramUser = tg.initDataUnsafe?.user || null;
    }
  } catch(e){ console.warn("tg not available", e); }
  // fallback guest id
  const getUserId = () => {
    if (telegramUser && telegramUser.id) return String(telegramUser.id);
    let g = localStorage.getItem('guest_user');
    if (!g) { g = 'guest_' + Date.now() + '_' + Math.random().toString(36).slice(2,6); localStorage.setItem('guest_user', g); }
    return g;
  };

  // utility: random int
  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

  // spawn banana
  function spawnBanana(){
    const b = document.createElement('div');
    b.className = 'banana';
    // random x within area
    const areaW = area.clientWidth;
    const x = Math.max(6, Math.floor(Math.random() * (areaW - 60)));
    b.style.left = x + 'px';
    b.style.top = '-70px';
    area.appendChild(b);
    bananas.add(b);

    // fall animation using JS (transition)
    const fallTime = randInt(FALL_SPEED_MIN, FALL_SPEED_MAX);
    b.style.transition = `transform ${fallTime}ms linear`;
    requestAnimationFrame(()=> {
      b.style.transform = `translateY(${area.clientHeight + 80}px)`; // fall beyond area
    });

    // remove after fallTime + small buffer
    const removeTimer = setTimeout(()=> {
      if (bananas.has(b)) {
        bananas.delete(b);
        b.remove();
      }
      clearTimeout(removeTimer);
    }, fallTime + 200);

    // click to pop
    b.addEventListener('click', (e)=> {
      e.stopPropagation();
      if (!gameRunning) return;
      // add pop visual
      const pop = document.createElement('div');
      pop.className = 'pop';
      pop.style.left = b.style.left;
      pop.style.top = b.style.top;
      area.appendChild(pop);
      setTimeout(()=> pop.remove(), 500);

      // increment score and remove banana
      score++;
      scoreEl.textContent = score;
      bananas.delete(b);
      b.remove();
      updateRewardPreview();
    });
  }

  function updateRewardPreview(){
    const reward = Math.min(MAX_REWARD, BASE_REWARD + score * MULTIPLIER);
    rewardPreviewEl.textContent = reward;
  }

  function startGame(){
    if (gameRunning) return;
    // reset
    gameRunning = true;
    score = 0;
    gameTimeLeft = DURATION;
    scoreEl.textContent = '0';
    timeEl.textContent = String(gameTimeLeft);
    updateRewardPreview();
    resultBox.style.display = 'none';
    adContainer.innerHTML = '';
    claimBtn.disabled = true;
    claimReady = false;
    // spawn loop
    spawnTimer = setInterval(spawnBanana, SPAWN_INTERVAL);
    // game timer
    gameTimer = setInterval(()=> {
      gameTimeLeft--;
      timeEl.textContent = String(gameTimeLeft);
      if (gameTimeLeft <= 0) {
        stopGame();
      }
    }, 1000);
    startBtn.disabled = true;
    stopBtn.disabled = false;
  }

  function stopGame(){
    if (!gameRunning) return;
    gameRunning = false;
    clearInterval(spawnTimer);
    clearInterval(gameTimer);
    // remove remaining bananas
    bananas.forEach(b=> b.remove());
    bananas.clear();
    // show results + ad
    const reward = Math.min(MAX_REWARD, BASE_REWARD + score * MULTIPLIER);
    resultText.innerHTML = `üèÅ ‡¶ó‡ßá‡¶Æ ‡¶∂‡ßá‡¶∑! ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ï‡ßã‡¶∞: <strong>${score}</strong><br>‡¶™‡ßç‡¶∞‡¶§‡ßç‡¶Ø‡¶æ‡¶∂‡¶ø‡¶§ ‡¶∞‡¶ø‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶°: <strong>${reward}</strong> ‡¶ï‡ßü‡ßá‡¶®`;
    resultBox.style.display = 'block';
    // insert ad (native/banner/social as you prefer)
    // --- Adsterra native example (your code) ---
    adContainer.innerHTML = `<script async="async" data-cfasync="false" src="//pl27590817.revenuecpmgate.com/15bb6fd989846930069557e9a22f454c/invoke.js"></script>
      <div id="container-15bb6fd989846930069557e9a22f454c"></div>`;
    // start 15s timer for claim
    let wait = 15;
    claimBtn.disabled = true;
    claimBtn.textContent = `Claim (wait ${wait}s)`;
    const w = setInterval(()=> {
      wait--;
      claimBtn.textContent = `Claim (wait ${wait}s)`;
      if (wait<=0){
        clearInterval(w);
        claimBtn.disabled = false;
        claimBtn.textContent = 'Claim Reward';
        claimReady = true;
      }
    },1000);
    startBtn.disabled = false;
    stopBtn.disabled = true;
  }

  // claim reward -> write to Firestore
  claimBtn.addEventListener('click', async ()=>{
    if (!claimReady) return;
    claimBtn.disabled = true;
    claimBtn.textContent = 'Claiming...';
    const reward = Math.min(MAX_REWARD, BASE_REWARD + score * MULTIPLIER);
    const userId = getUserId();
    try {
      const userRef = doc(db, 'users', userId);
      const snap = await getDoc(userRef);
      if (!snap.exists()){
        // create user doc (guest or telegram)
        await setDoc(userRef, {
          name: (telegramUser && (telegramUser.first_name || telegramUser.username)) || 'Guest',
          telegramId: (telegramUser && telegramUser.id) || null,
          coins: reward
        });
      } else {
        await updateDoc(userRef, {
          coins: increment(reward)
        });
      }
      resultText.innerHTML += `<br/><strong style="color:green">‚úÖ ${reward} ‡¶ï‡ßü‡ßá‡¶® ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá‡¶õ‡ßá!</strong>`;
      claimBtn.textContent = 'Claimed';
    } catch(err){
      console.error(err);
      resultText.innerHTML += `<br/><strong style="color:red">Error: Could not credit coins.</strong>`;
      claimBtn.disabled = false;
      claimBtn.textContent = 'Claim Reward';
    }
  });

  // stop button
  stopBtn.addEventListener('click', ()=>{
    if (gameRunning) stopGame();
  });

  // start button
  startBtn.addEventListener('click', ()=> startGame());

  // initial UI
  updateRewardPreview();
  </script>
</body>
</html>
